// Utility to add message to chat
function addMessage(sender, text) {
  const chatBox = document.getElementById("chat-box");
  const message = document.createElement("div");
  message.className = "message";
  message.innerHTML = `<strong>${sender}:</strong> ${text}`;
  chatBox.appendChild(message);
}

// Toggle file select modal
const attachmentBtn = document.getElementById("attachment-button");
const fileModal = document.getElementById("file-select-modal");
const selectPDF = document.getElementById("select-pdf");
const selectImage = document.getElementById("select-image");

attachmentBtn.addEventListener("click", (e) => {
  e.stopPropagation();
  fileModal.classList.toggle("hidden");
});

document.addEventListener("click", (e) => {
  if (!attachmentBtn.contains(e.target)) {
    fileModal.classList.add("hidden");
  }
});

// PDF Upload
selectPDF.addEventListener("click", () => {
  fileModal.classList.add("hidden");
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/pdf";
  input.onchange = async () => {
    const file = input.files[0];
    if (!file) return;
    const formData = new FormData();
    formData.append("pdf", file);
    addMessage("Nova X", "üìÑ Processing PDF...");
    try {
      const res = await fetch("https://nova-x-v2-backend.onrender.com/pdf", {
        method: "POST",
        body: formData
      });
      const result = await res.json();
      const summaryPrompt = `Summarize this PDF:\n\n${result.text.slice(0, 3000)}`;
      const chatRes = await fetch("https://nova-x-v2-backend.onrender.com/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: summaryPrompt })
      });
      const data = await chatRes.json();
      addMessage("Nova X", data.response);
    } catch (e) {
      addMessage("Nova X", "‚ùå Failed to process PDF.");
    }
  };
  input.click();
});

// Image Upload + OCR
selectImage.addEventListener("click", () => {
  fileModal.classList.add("hidden");
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.onchange = async () => {
    const file = input.files[0];
    if (!file) return;
    addMessage("Nova X", "üñºÔ∏è Extracting text from image...");
    try {
      const { createWorker } = window.Tesseract;
      const worker = await createWorker("eng");
      const { data: { text } } = await worker.recognize(file);
      await worker.terminate();
      const summaryPrompt = `Analyze this image:\n\n${text}`;
      const chatRes = await fetch("https://nova-x-v2-backend.onrender.com/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: summaryPrompt })
      });
      const data = await chatRes.json();
      addMessage("Nova X", data.response);
    } catch (e) {
      addMessage("Nova X", "‚ùå OCR failed.");
    }
  };
  input.click();
});
